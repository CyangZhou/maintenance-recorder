cGFja2FnZSBjb20ucGFwZXJtaWxsLm1haW50ZW5hbmNlLnVpLnNjcmVlbgoKaW1wb3J0IGFuZHJvaWQuTWFuaWZlc3QKaW1wb3J0IGFuZHJvaWQuY29udGVudC5Db250ZXh0CmltcG9ydCBhbmRyb2lkLmNvbnRlbnQucG0uUGFja2FnZU1hbmFnZXIKaW1wb3J0IGFuZHJvaWQubmV0LlVyaQppbXBvcnQgYW5kcm9pZC5zcGVlY2guUmVjb2duaXplckludGVudAppbXBvcnQgYW5kcm9pZC53aWRnZXQuVG9hc3QKaW1wb3J0IGFuZHJvaWQuYWN0aXZpdHkuY29tcG9zZS5yZW1lbWJlckxhdW5jaGVyRm9yQWN0aXZpdHlSZXN1bHQKaW1wb3J0IGFuZHJvaWQuYWN0aXZpdHkucmVzdWx0LmNvbnRyYWN0LkFjdGl2aXR5UmVzdWx0Q29udHJhY3RzCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UuZm91bmRhdGlvbi5iYWNrZ3JvdW5kCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UuZm91bmRhdGlvbi5ob3Jpem9udGFsU2Nyb2xsCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UuZm91bmRhdGlvbi5sYXlvdXQuKgppbXBvcnQgYW5kcm9pZC5jb21wb3NlLmZvdW5kYXRpb24ucmVtZW1iZXJTY3JvbGxTdGF0ZQppbXBvcnQgYW5kcm9pZC5jb21wb3NlLmZvdW5kYXRpb24uc2hhcGUuUm91bmRlZENvcm5lclNoYXBlCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UuZm91bmRhdGlvbi52ZXJ0aWNhbFNjcm9sbAppbXBvcnQgYW5kcm9pZC5jb21wb3NlLm1hdGVyaWFsLmljb25zLkljb25zCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UubWF0ZXJpYWwuaWNvbnMuZmlsbGVkLioKaW1wb3J0IGFuZHJvaWQuY29tcG9zZS5tYXRlcmlhbDMuKgppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnJ1bnRpbWUuKgppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnVpLkFsaWdubWVudAppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnVpLk1vZGlmaWVyCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UudWkuZHJhdy5jbGlwCmltcG9ydCBhbmRyb2lkLmNvbXBvc2UudWkubGF5b3V0LkNvbnRlbnRTY2FsZQppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnVpLnBsYXRmb3JtLkxvY2FsQ29udGV4dAppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnVpLnJlcy5zdHJpbmdSZXNvdXJjZQppbXBvcnQgYW5kcm9pZC5jb21wb3NlLnVpLnVuaXQuZHAKaW1wb3J0IGFuZHJvaWQuY29yZS5jb250ZW50LkNvbnRleHRDb21wYXQKaW1wb3J0IGFuZHJvaWQuY29yZS5jb250ZW50LkZpbGVQcm92aWRlcgppbXBvcnQgYW5kcm9pZC5saWZlY3ljbGUudmlld21vZGVsLmNvbXBvc2Uudmlld01vZGVsCmltcG9ydCBjb2lsLmNvbXBvc2UuQXN5bmNJbWFnZQppbXBvcnQgY29pbC5yZXF1ZXN0LkltYWdlUmVxdWVzdAppbXBvcnQgY29tLnBhcGVybWlsbC5tYWludGVuYW5jZS5SCmltcG9ydCBjb20ucGFwZXJtaWxsLm1haW50ZW5hbmNlLmRpLkFwcE1vZHVsZQppbXBvcnQgY29tLnBhcGVybWlsbC5tYWludGVuYW5jZS51aS50aGVtZS4qCmltcG9ydCBjb20ucGFwZXJtaWxsLm1haW50ZW5hbmNlLnVpLnZpZXdtb2RlbC5SZWNvcmREZXRhaWxWaWV3TW9kZWwKaW1wb3J0IGphdmEuaW8uRmlsZQppbXBvcnQgamF2YS50ZXh0LlNpbXBsZURhdGVGb3JtYXQKaW1wb3J0IGphdmEudXRpbC4qCgpAT3B0SW4oRXhwZXJpbWVudGFsTWF0ZXJpYWwzQXBpOjpjbGFzcykKQENvbXBvc2FibGUKZnVuIFJlY29yZERldGFpbFNjcmVlbigKICAgIHJlY29yZElkOiBMb25nLAogICAgb25OYXZpZ2F0ZUJhY2s6ICgpIC0+IFVuaXQsCiAgICB2aWV3TW9kZWw6IFJlY29yZERldGFpbFZpZXdNb2RlbCA9IHZpZXdNb2RlbCgKICAgICAgICBmYWN0b3J5ID0gUmVjb3JkRGV0YWlsVmlld01vZGVsLkZhY3RvcnkoCiAgICAgICAgICAgIEFwcE1vZHVsZS5nZXRSZXBvc2l0b3J5KExvY2FsQ29udGV4dC5jdXJyZW50KQogICAgICAgICkKICAgICkKewogICAgdmFsIHVpU3RhdGUgYnkgdmlld01vZGVsLnVpU3RhdGUuY29sbGVjdEFzU3RhdGUoKQogICAgdmFsIGNvbnRleHQgPSBMb2NhbENvbnRleHQuY3VycmVudAogICAgCiAgICB2YXIgdm9pY2VJbnB1dFRhcmdldCBieSByZW1lbWJlciB7IG11dGFibGVTdGF0ZU9mPFZvaWNlSW5wdXRUYXJnZXQ/PihudWxsKSB9CiAgICB2YXIgdGVtcFBob3RvVXJpIGJ5IHJlbWVtYmVyIHsgbXV0YWJsZVN0YXRlT2Y8VXJpPz4obnVsbCkgfQogICAgCiAgICB2YWwgY2FtZXJhTGF1bmNoZXIgPSByZW1lbWJlckxhdW5jaGVyRm9yQWN0aXZpdHlSZXN1bHQoCiAgICAgICAgQWN0aXZpdHlSZXN1bHRDb250cmFjdHMuVGFrZVBpY3R1cmUoKQogICAgKSB7IHN1Y2Nlc3MgLT4KICAgICAgICBpZiAoc3VjY2VzcyAmJiB0ZW1wUGhvdG9VcmkgIT0gbnVsbCkgewogICAgICAgICAgICB2aWV3TW9kZWwuYWRkSW1hZ2UodGVtcFBob3RvVXJpLnRvU3RyaW5nKCkpCiAgICAgICAgfQogICAgfQogICAgCiAgICB2YWwgaW1hZ2VQaWNrZXJMYXVuY2hlciA9IHJlbWVtYmVyTGF1bmNoZXJGb3JBY3Rpdml0eVJlc3VsdCgKICAgICAgICBBY3Rpdml0eVJlc3VsdENvbnRyYWN0cy5HZXRDb250ZW50KCkKICAgICkgeyB1cmk6IFVyaT8gLT4KICAgICAgICB1cmk/LmxldCB7IHZpZXdNb2RlbC5hZGRJbWFnZShpdC50b1N0cmluZygpKSB9CiAgICB9CiAgICAKICAgIHZhbCBzcGVlY2hSZWNvZ25pemVyTGF1bmNoZXIgPSByZW1lbWJlckxhdW5jaGVyRm9yQWN0aXZpdHlSZXN1bHQoCiAgICAgICAgQWN0aXZpdHlSZXN1bHRDb250cmFjdHMuU3RhcnRBY3Rpdml0eUZvclJlc3VsdCgpCiAgICApIHsgcmVzdWx0IC0+CiAgICAgICAgdmFsIHJlc3VsdHMgPSByZXN1bHQuZGF0YT8uZ2V0U3RyaW5nQXJyYXlMaXN0RXh0cmEoUmVjb2duaXplckludGVudC5FWFRSQV9SRVNVTFRTKQogICAgICAgIHJlc3VsdHM/LmZpcnN0T3JOdWxsKCk/LmxldCB7IHRleHQgLT4KICAgICAgICAgICAgd2hlbiAodm9pY2VJbnB1dFRhcmdldCkgewogICAgICAgICAgICAgICAgVm9pY2VJbnB1dFRhcmdldC5USVRMRSAtPiB2aWV3TW9kZWwub25UaXRsZUNoYW5nZSh1aVN0YXRlLnRpdGxlICsgdGV4dCkKICAgICAgICAgICAgICAgIFZvaWNlSW5wdXRUYXJnZXQuQ09OVEVOVCAtPiB2aWV3TW9kZWwub25Db250ZW50Q2hhbmdlKHVpU3RhdGUuY29udGVudCArIHRleHQpCiAgICAgICAgICAgICAgICBWb2ljZUlucHV0VGFyZ2V0LkVRVUlQTUVOVCAtPiB2aWV3TW9kZWwub25FcXVpcG1lbnROYW1lQ2hhbmdlKHVpU3RhdGUuZXF1aXBtZW50TmFtZSArIHRleHQpCiAgICAgICAgICAgICAgICBudWxsIC0+IHt9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdm9pY2VJbnB1dFRhcmdldCA9IG51bGwKICAgIH0KICAgIAogICAgdmFsIGNhbWVyYVBlcm1pc3Npb25MYXVuY2hlciA9IHJlbWVtYmVyTGF1bmNoZXJGb3JBY3Rpdml0eVJlc3VsdCgKICAgICAgICBBY3Rpdml0eVJlc3VsdENvbnRyYWN0cy5SZXF1ZXN0UGVybWlzc2lvbigpCiAgICApIHsgaXNHcmFudGVkIC0+CiAgICAgICAgaWYgKGlzR3JhbnRlZCkgewogICAgICAgICAgICBsYXVuY2hDYW1lcmEoY29udGV4dCwgY2FtZXJhTGF1bmNoZXIpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgVG9hc3QubWFrZVRleHQoY29udGV4dCwgY29udGV4dC5nZXRTdHJpbmcoUi5zdHJpbmcuY2FtZXJhX3Blcm1pc3Npb25fcmVxdWlyZWQpLCBUb2FzdC5MRU5HVEhfU0hPUlQpLnNob3coKQogICAgICAgIH0KICAgIH0KICAgIAogICAgdmFsIG1pY3JvcGhvbmVQZXJtaXNzaW9uTGF1bmNoZXIgPSByZW1lbWJlckxhdW5jaGVyRm9yQWN0aXZpdHlSZXN1bHQoCiAgICAgICAgQWN0aXZpdHlSZXN1bHRDb250cmFjdHMuUmVxdWVzdFBlcm1pc3Npb24oKQogICAgKSB7IGlzR3JhbnRlZCAtPgogICAgICAgIGlmIChpc0dyYW50ZWQpIHsKICAgICAgICAgICAgc3RhcnRWb2ljZVJlY29nbml0aW9uKGNvbnRleHQsIHNwZWVjaFJlY29nbml6ZXJMYXVuY2hlcikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBUb2FzdC5tYWtlVGV4dChjb250ZXh0LCBjb250ZXh0LmdldFN0cmluZyhSLnN0cmluZy5taWNyb3Bob25lX3Blcm1pc3Npb25fcmVxdWlyZWQpLCBUb2FzdC5MRU5HVEhfU0hPUlQpLnNob3coKQogICAgICAgIH0KICAgIH0KICAgIAogICAgTGF1bmNoZWRFZmZlY3QocmVjb3JkSWQpIHsKICAgICAgICB2aWV3TW9kZWwubG9hZFJlY29yZChyZWNvcmRJZCkKICAgIH0KICAgIAogICAgTGF1bmNoZWRFZmZlY3QodWlTdGF0ZS5zYXZlQ29tcGxldGUpIHsKICAgICAgICBpZiAodWlTdGF0ZS5zYXZlQ29tcGxldGUpIHsKICAgICAgICAgICAgVG9hc3QubWFrZVRleHQoY29udGV4dCwgIuS/neWtmOeahCIsIFRvYXN0LkxFTkdUSF9TSE9SVCkuc2hvdygpCiAgICAgICAgICAgIG9uTmF2aWdhdGVCYWNrKCkKICAgICAgICB9CiAgICB9CiAgICAKICAgIFNjYWZmb2xkKAogICAgICAgIHRvcEJhciA9IHsKICAgICAgICAgICAgVG9wQXBwQmFyKAogICAgICAgICAgICAgICAgdGl0bGUgPSB7IAogICAgICAgICAgICAgICAgICAgIFRleHQoCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1aVN0YXRlLmlzTmV3UmVjb3JkKSBzdHJpbmdSZXNvdXJjZShSLnN0cmluZy5hZGRfcmVjb3JkKSAKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBzdHJpbmdSZXNvdXJjZShSLnN0cmluZy5lZGl0X3JlY29yZCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY29sb3JzID0gVG9wQXBwQmFyRGVmYXVsdHMudG9wQXBwQmFyQ29sb3JzKAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckNvbG9yID0gUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICB0aXRsZUNvbnRlbnRDb2xvciA9IFN1cmZhY2VDb2xvcgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIG5hdmlnYXRpb25JY29uID0gewogICAgICAgICAgICAgICAgICAgIEljb25CdXR0b24ob25DbGljayA9IG9uTmF2aWdhdGVCYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEljb24oSWNvbnMuRGVmYXVsdC5BcnJvd0JhY2ssICLiuaBluZciLCB0aW50ID0gU3VyZmFjZUNvbG9yKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhY3Rpb25zID0gewogICAgICAgICAgICAgICAgICAgIEljb25CdXR0b24oCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2sgPSB7IHZpZXdNb2RlbC5zYXZlUmVjb3JkKCkgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZCA9IHVpU3RhdGUudGl0bGUuaXNOb3RCbGFuaygpICYmICF1aVN0YXRlLmlzU2F2aW5nCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1aVN0YXRlLmlzU2F2aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaXJjdWxhclByb2dyZXNzSW5kaWNhdG9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmaWVyID0gTW9kaWZpZXIuc2l6ZSgyNC5kcCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBTdXJmYWNlQ29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEljb24oSWNvbnMuRGVmYXVsdC5TYXZlLCBzdHJpbmdSZXNvdXJjZShSLnN0cmluZy5zYXZlKSwgdGludCA9IFN1cmZhY2VDb2xvcikKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIH0KICAgICkgeyBwYWRkaW5nVmFsdWVzIC0+CiAgICAgICAgQ29sdW1uKAogICAgICAgICAgICBtb2RpZmllciA9IE1vZGlmaWVyCiAgICAgICAgICAgICAgICAuZmlsbE1heFNpemUoKQogICAgICAgICAgICAgICAgLnBhZGRpbmcocGFkZGluZ1ZhbHVlcykKICAgICAgICAgICAgICAgIC52ZXJ0aWNhbFNjcm9sbChyZW1lbWJlclNjcm9sbFN0YXRlKCkpCiAgICAgICAgICAgICAgICAucGFkZGluZygxNi5kcCksCiAgICAgICAgICAgIHZlcnRpY2FsQXJyYW5nZW1lbnQgPSBBcnJhbmdlbWVudC5zcGFjZWRCeSgxNi5kcCkKICAgICAgICApIHsKICAgICAgICAgICAgT3V0bGluZWRUZXh0RmllbGQoCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHVpU3RhdGUudGl0bGUsCiAgICAgICAgICAgICAgICBvblZhbHVlQ2hhbmdlID0geyB2aWV3TW9kZWwub25UaXRsZUNoYW5nZShpdCkgfSwKICAgICAgICAgICAgICAgIGxhYmVsID0geyBUZXh0KHN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLnRpdGxlX2xhYmVsKSkgfSwKICAgICAgICAgICAgICAgIG1vZGlmaWVyID0gTW9kaWZpZXIuZmlsbE1heFdpZHRoKCksCiAgICAgICAgICAgICAgICBzaW5nbGVMaW5lID0gdHJ1ZSwKICAgICAgICAgICAgICAgIHRyYWlsaW5nSWNvbiA9IHsKICAgICAgICAgICAgICAgICAgICBJY29uQnV0dG9uKG9uQ2xpY2sgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZvaWNlSW5wdXRUYXJnZXQgPSBWb2ljZUlucHV0VGFyZ2V0LlRJVExFCiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrQW5kUmVxdWVzdE1pY3JvcGhvbmVQZXJtaXNzaW9uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWNyb3Bob25lUGVybWlzc2lvbkxhdW5jaGVyCiAgICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRWb2ljZVJlY29nbml0aW9uKGNvbnRleHQsIHNwZWVjaFJlY29nbml6ZXJMYXVuY2hlcikKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgSWNvbihJY29ucy5EZWZhdWx0Lk1pYywgc3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcudm9pY2VfaW5wdXQpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgT3V0bGluZWRUZXh0RmllbGQoCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHVpU3RhdGUuZXF1aXBtZW50TmFtZSwKICAgICAgICAgICAgICAgIG9uVmFsdWVDaGFuZ2UgPSB7IHZpZXdNb2RlbC5vbkVxdWlwbWVudE5hbWVDaGFuZ2UoaXQpIH0sCiAgICAgICAgICAgICAgICBsYWJlbCA9IHsgVGV4dChzdHJpbmdSZXNvdXJjZShSLnN0cmluZy5lcXVpcG1lbnRfbGFiZWwpKSB9LAogICAgICAgICAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllci5maWxsTWF4V2lkdGgoKSwKICAgICAgICAgICAgICAgIHNpbmdsZUxpbmUgPSB0cnVlLAogICAgICAgICAgICAgICAgdHJhaWxpbmdJY29uID0gewogICAgICAgICAgICAgICAgICAgIEljb25CdXR0b24ob25DbGljayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdm9pY2VJbnB1dFRhcmdldCA9IFZvaWNlSW5wdXRUYXJnZXQuRVFVSVBNRU5UCiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrQW5kUmVxdWVzdE1pY3JvcGhvbmVQZXJtaXNzaW9uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pY3JvcGhvbmVQZXJtaXNzaW9uTGF1bmNoZXIKICAgICAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydFZvaWNlUmVjb2duaXRpb24oY29udGV4dCwgc3BlZWNoUmVjb2duaXplckxhdW5jaGVyKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkgewogICAgICAgICAgICAgICAgICAgICAgICBJY29uKEljb25zLkRlZmF1bHQuTWljLCBzdHJpbmdSZXNvdXJjZShSLnN0cmluZy52b2ljZV9pbnB1dCkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBPdXRsaW5lZFRleHRGaWVsZCgKICAgICAgICAgICAgICAgIHZhbHVlID0gdWlTdGF0ZS5jb250ZW50LAogICAgICAgICAgICAgICAgb25WYWx1ZUNoYW5nZSA9IHsgdmlld01vZGVsLm9uQ29udGVudENoYW5nZShpdCkgfSwKICAgICAgICAgICAgICAgIGxhYmVsID0geyBUZXh0KHN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLmNvbnRlbnRfbGFiZWwpKSB9LAogICAgICAgICAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllcgogICAgICAgICAgICAgICAgICAgIC5maWxsTWF4V2lkdGgoKQogICAgICAgICAgICAgICAgICAgIC5oZWlnaHQoMjAwLmRwKSwKICAgICAgICAgICAgICAgIHRyYWlsaW5nSWNvbiA9IHsKICAgICAgICAgICAgICAgICAgICBJY29uQnV0dG9uKG9uQ2xpY2sgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZvaWNlSW5wdXRUYXJnZXQgPSBWb2ljZUlucHV0VGFyZ2V0LkNPTlRFTlQKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tBbmRSZXF1ZXN0TWljcm9waG9uZVBlcm1pc3Npb24oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWljcm9waG9uZVBlcm1pc3Npb25MYXVuY2hlcgogICAgICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0Vm9pY2VSZWNvZ25pdGlvbihjb250ZXh0LCBzcGVlY2hSZWNvZ25pemVyTGF1bmNoZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEljb24oSWNvbnMuRGVmYXVsdC5NaWMsIHN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLnZvaWNlX2lucHV0KSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIFRleHQoCiAgICAgICAgICAgICAgICB0ZXh0ID0gc3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcuaW1hZ2VzX2xhYmVsKSwKICAgICAgICAgICAgICAgIHN0eWxlID0gTWF0ZXJpYWxUaGVtZS50eXBvZ3JhcGh5LnRpdGxlTWVkaXVtLAogICAgICAgICAgICAgICAgY29sb3IgPSBUZXh0UHJpbWFyeQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBSb3coCiAgICAgICAgICAgICAgICBtb2RpZmllciA9IE1vZGlmaWVyLmZpbGxNYXhXaWR0aCgpLAogICAgICAgICAgICAgICAgaG9yaXpvbnRhbEFycmFuZ2VtZW50ID0gQXJyYW5nZW1lbnQuc3BhY2VkQnkoOC5kcCkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBCdXR0b24oCiAgICAgICAgICAgICAgICAgICAgb25DbGljayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tBbmRSZXF1ZXN0Q2FtZXJhUGVybWlzc2lvbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmFQZXJtaXNzaW9uTGF1bmNoZXIKICAgICAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXVuY2hDYW1lcmEoY29udGV4dCwgY2FtZXJhTGF1bmNoZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG1vZGlmaWVyID0gTW9kaWZpZXIud2VpZ2h0KDFmKSwKICAgICAgICAgICAgICAgICAgICBjb2xvcnMgPSBCdXR0b25EZWZhdWx0cy5idXR0b25Db2xvcnMoY29udGFpbmVyQ29sb3IgPSBQcmltYXJ5KQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgSWNvbihJY29ucy5EZWZhdWx0LkNhbWVyYUFsdCwgY29udGVudERlc2NyaXB0aW9uID0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBTcGFjZXIobW9kaWZpZXIgPSBNb2RpZmllci53aWR0aCg4LmRwKSkKICAgICAgICAgICAgICAgICAgICBUZXh0KHN0cmluZ1Jlc291cmNlKFIuc3RyaW5nLnRha2VfcGhvdG8pKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBPdXRsaW5lZEJ1dHRvbigKICAgICAgICAgICAgICAgICAgICBvbkNsaWNrID0geyBpbWFnZVBpY2tlckxhdW5jaGVyLmxhdW5jaCgiaW1hZ2UvKiIpIH0sCiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllci53ZWlnaHQoMWYpCiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICBJY29uKEljb25zLkRlZmF1bHQuUGhvdG9MaWJyYXJ5LCBjb250ZW50RGVzY3JpcHRpb24gPSBudWxsKQogICAgICAgICAgICAgICAgICAgIFNwYWNlcihtb2RpZmllciA9IE1vZGlmaWVyLndpZHRoKDguZHApKQogICAgICAgICAgICAgICAgICAgIFRleHQoc3RyaW5nUmVzb3VyY2UoUi5zdHJpbmcuc2VsZWN0X2ltYWdlKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHVpU3RhdGUuaW1hZ2VQYXRocy5pc05vdEVtcHR5KCkpIHsKICAgICAgICAgICAgICAgIFJvdygKICAgICAgICAgICAgICAgICAgICBtb2RpZmllciA9IE1vZGlmaWVyCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWxsTWF4V2lkdGgoKQogICAgICAgICAgICAgICAgICAgICAgICAuaG9yaXpvbnRhbFNjcm9sbChyZW1lbWJlclNjcm9sbFN0YXRlKCkpLAogICAgICAgICAgICAgICAgICAgICAgICBob3Jpem9udGFsQXJyYW5nZW1lbnQgPSBBcnJhbmdlbWVudC5zcGFjZWRCeSg4LmRwKQogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICB1aVN0YXRlLmltYWdlUGF0aHMuZm9yRWFjaCB7IGltYWdlUGF0aCAtPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgSW1hZ2VUaHVtYm5haWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VQYXRoID0gaW1hZ2VQYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUmVtb3ZlID0geyB2aWV3TW9kZWwucmVtb3ZlSW1hZ2UoaW1hZ2VQYXRoKSB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghdWlTdGF0ZS5pc05ld1JlY29yZCkgewogICAgICAgICAgICAgICAgICAgIHZhbCBkYXRlRm9ybWF0ID0gU2ltcGxlRGF0ZUZvcm1hdCgieXl5eS1NTS1kZCBISDptbSIsIExvY2FsZS5nZXREZWZhdWx0KCkpCiAgICAgICAgICAgICAgICAgICAgVGV4dCgKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9ICIke3N0cmluZ1Jlc291cmNlKFIuc3RyaW5nLnRpbWVfbGFiZWwpfTogJHtkYXRlRm9ybWF0LmZvcm1hdChEYXRlKHVpU3RhdGUuaWQpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IE1hdGVyaWFsVGhlbWUudHlwb2dyYXBoeS5ib2R5U21hbGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID0gVGV4dFNlY29uZGFyeQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICkKfQoKcHJpdmF0ZSBlbnVtIGNsYXNzIFZvaWNlSW5wdXRUYXJnZXQgewogICAgVElUTEUsIENPTlRFTlQsIEVRVUlQTUVOVAp9CgpAQ29tcG9zYWJsZQpwcml2YXRlIGZ1biBJbWFnZVRodW1ibmFpbCgKICAgIGltYWdlUGF0aDogU3RyaW5nLAogICAgb25SZW1vdmU6ICgpIC0+IFVuaXQKKSB7CiAgICBCb3goCiAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllci5zaXplKDEwMC5kcCkKICAgICkgewogICAgICAgIEFzeW5jSW1hZ2UoCiAgICAgICAgICAgIG1vZGVsID0gSW1hZ2VSZXF1ZXN0LkJ1aWxkZXIoTG9jYWxDb250ZXh0LmN1cnJlbnQpCiAgICAgICAgICAgICAgICAuZGF0YShpbWFnZVBhdGgpCiAgICAgICAgICAgICAgICAuY3Jvc3NmYWRlKHRydWUpCiAgICAgICAgICAgICAgICAuYnVpbGQoKSwKICAgICAgICAgICAgY29udGVudERlc2NyaXB0aW9uID0gbnVsbCwKICAgICAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllcgogICAgICAgICAgICAgICAgLmZpbGxNYXhTaXplKCkKICAgICAgICAgICAgICAgIC5jbGlwKE1hdGVyaWFsVGhlbWUuc2hhcGVzLm1lZGl1bSksCiAgICAgICAgICAgIGNvbnRlbnRTY2FsZSA9IENvbnRlbnRTY2FsZS5Dcm9wCiAgICAgICAgKQogICAgICAgIAogICAgICAgIEljb25CdXR0b24oCiAgICAgICAgICAgIG9uQ2xpY2sgPSBvblJlbW92ZSwKICAgICAgICAgICAgbW9kaWZpZXIgPSBNb2RpZmllcgogICAgICAgICAgICAgICAgLmFsaWduKEFsaWdubWVudC5Ub3BFbmQpCiAgICAgICAgICAgICAgICAuc2l6ZSgzMi5kcCkKICAgICAgICAgICAgICAgIC5iYWNrZ3JvdW5kKEVycm9yLCBSb3VuZGVkQ29ybmVyU2hhcGUoNTApKQogICAgICAgICkgewogICAgICAgICAgICBJY29uKAogICAgICAgICAgICAgICAgSWNvbnMuRGVmYXVsdC5DbG9zZSwKICAgICAgICAgICAgICAgIGNvbnRlbnREZXNjcmlwdGlvbiA9ICLiiafooYzlm77niYciLAogICAgICAgICAgICAgICAgdGludCA9IFN1cmZhY2VDb2xvciwKICAgICAgICAgICAgICAgIG1vZGlmaWVyID0gTW9kaWZpZXIuc2l6ZSgxNi5kcCkKICAgICAgICAgICAgKQogICAgICAgIH0KICAgIH0KfQoKcHJpdmF0ZSBmdW4gY2hlY2tBbmRSZXF1ZXN0Q2FtZXJhUGVybWlzc2lvbigKICAgIGNvbnRleHQ6IENvbnRleHQsCiAgICBsYXVuY2hlcjogYW5kcm9pZC5hY3Rpdml0eS5yZXN1bHQuYWN0aXZpdHlyZXN1bHQuQWN0aXZpdHlSZXN1bHRMYXVuY2hlcjxTdHJpbmc+LAogICAgb25HcmFudGVkOiAoKSAtPiBVbml0CikgewogICAgaWYgKENvbnRleHRDb21wYXQuY2hlY2tTZWxmUGVybWlzc2lvbihjb250ZXh0LCBNYW5pZmVzdC5wZXJtaXNzaW9uLkNBTUVSQSkgCiAgICAgICAgPT0gUGFja2FnZU1hbmFnZXIuUEVSTUlTU0lPTl9HUkFOVEVEKSB7CiAgICAgICAgb25HcmFudGVkKCkKICAgIH0gZWxzZSB7CiAgICAgICAgbGF1bmNoZXIubGF1bmNoKE1hbmlmZXN0LnBlcm1pc3Npb24uQ0FNRVJBKQogICAgfQp9Cgpwcml2YXRlIGZ1biBjaGVja0FuZFJlcXVlc3RNaWNyb3Bob25lUGVybWlzc2lvbigKICAgIGNvbnRleHQ6IENvbnRleHQsCiAgICBsYXVuY2hlcjogYW5kcm9pZC5hY3Rpdml0eS5yZXN1bHQuYWN0aXZpdHlyZXN1bHQuQWN0aXZpdHlSZXN1bHRMYXVuY2hlcjxTdHJpbmc+LAogICAgb25HcmFudGVkOiAoKSAtPiBVbml0CikgewogICAgaWYgKENvbnRleHRDb21wYXQuY2hlY2tTZWxmUGVybWlzc2lvbihjb250ZXh0LCBNYW5pZmVzdC5wZXJtaXNzaW9uLlJFQ09SRF9BVURJTykgCiAgICAgICAgPT0gUGFja2FnZU1hbmFnZXIuUEVSTUlTU0lPTl9HUkFOVEVEKSB7CiAgICAgICAgb25HcmFudGVkKCkKICAgIH0gZWxzZSB7CiAgICAgICAgbGF1bmNoZXIubGF1bmNoKE1hbmlmZXN0LnBlcm1pc3Npb24uUkVDT1JEX0FVRElPKQogICAgfQp9Cgpwcml2YXRlIGZ1biBsYXVuY2hDYW1lcmEoCiAgICBjb250ZXh0OiBDb250ZXh0LAogICAgbGF1bmNoZXI6IGFuZHJvaWQuYWN0aXZpdHkucmVzdWx0LmFjdGl2aXR5cmVzdWx0LkFjdGl2aXR5UmVzdWx0TGF1bmNoZXI8VXJpPgpKewogICAgdmFsIHBob3RvRmlsZSA9IEZpbGUoCiAgICAgICAgY29udGV4dC5jYWNoZURpciwKICAgICAgICAicGhvdG9fJHtTeXN0ZW0uY3VycmVudFRpbWVNaWxsaXMoKX0uanBnIgogICAgKQogICAgdmFsIHBob3RvVXJpID0gRmlsZVByb3ZpZGVyLmdldFVyaUZvckZpbGUoCiAgICAgICAgY29udGV4dCwKICAgICAgICAiJHtjb250ZXh0LnBhY2thZ2VOYW1lfS5maWxlcHJvdmlkZXIiLAogICAgICAgIHBob3RvRmlsZQogICAgKQogICAgbGF1bmNoZXIubGF1bmNoKHBob3RvVXJpKQp9Cgpwcml2YXRlIGZ1biBzdGFydFZvaWNlUmVjb2duaXRpb24oCiAgICBjb250ZXh0OiBDb250ZXh0LAogICAgbGF1bmNoZXI6IGFuZHJvaWQuYWN0aXZpdHkucmVzdWx0LmFjdGl2aXR5cmVzdWx0LkFjdGl2aXR5UmVzdWx0TGF1bmNoZXI8YW5kcm9pZC5jb250ZW50LkludGVudD4KKSB7CiAgICB2YWwgaW50ZW50ID0gYW5kcm9pZC5jb250ZW50LkludGVudChSZWNvZ25pemVySW50ZW50LkFDVElPTl9SRUNPR05JWkVfU1BFRUNIKS5hcHBseSB7CiAgICAgICAgcHV0RXh0cmEoUmVjb2duaXplckludGVudC5FWFRSQV9MQU5HVUFHRV9NT0RFTCwgUmVjb2duaXplckludGVudC5MQU5HVUFHRV9NT0RFTF9GUkVFX0ZPUk0pCiAgICAgICAgcHV0RXh0cmEoUmVjb2duaXplckludGVudC5FWFRSQV9MQU5HVUFHRSwgInpoLUNOIikKICAgICAgICBwdXRFeHRyYShSZWNvZ25pemVySW50ZW50LkVYVFJBX1BST01QVCwgIuivt+mAieaLqeWtl+autCIpCiAgICB9CiAgICBsYXVuY2hlci5sYXVuY2goaW50ZW50KQp9